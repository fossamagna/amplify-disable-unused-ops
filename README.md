# amplify-disable-unused-ops

A CLI tool that automatically detects and disables unused GraphQL operations in AWS Amplify Gen2 projects.

## Overview

This tool scans TypeScript projects to identify actually used Amplify DataClient operations (query/mutation/subscription) and disables unused operations using `disableOperations()`, preventing the generation of unnecessary API endpoints.

## Key Features

- **Usage Scanning**: Analyzes TypeScript files in your project to detect which models and operations are actually being used
- **Automatic Disabling**: Automatically disables unused operations with `disableOperations()`
- **Backup**: Automatically creates backups of resource files before making changes (optional)
- **Dry Run**: Preview changes before actually applying them

## Installation

```bash
npm add -D amplify-disable-unused-ops
```

## Usage

### 1. Scan Usage

Scan TypeScript files in your project to detect which Amplify operations are being used.

```bash
amplify-disable-unused-ops scan --project tsconfig.json --out usage.json
```

**Options:**
- `--project`: Path to the TypeScript project configuration file (tsconfig.json)
- `--out`: Path to the JSON file where usage information will be written

**Example output (usage.json):**
```json
{
  "Todo": ["create", "list"],
  "User": ["get", "update"]
}
```

### 2. Disable Unused Operations

Update the Amplify resource file to disable unused operations based on the scan results.

```bash
amplify-disable-unused-ops apply --resource amplify/data/resource.ts --usage usage.json
```

**Options:**
- `--resource`: Path to the Amplify resource definition file (resource.ts)
- `--usage`: Path to the usage JSON file generated by the scan command
- `--dry-run`: Preview changes without actually modifying files
- `--no-backup`: Skip creating a backup file (backup is created by default)

**Dry run example:**
```bash
amplify-disable-unused-ops apply --resource amplify/data/resource.ts --usage usage.json --dry-run
```

## Operation Types

This tool detects and manages the following operation types:

### Query Operations
- `get`: Retrieve a single record
- `list`: Retrieve multiple records

### Mutation Operations
- `create`: Create a record
- `update`: Update a record
- `delete`: Delete a record

### Subscription Operations
- `onCreate`: Real-time notification on record creation
- `onUpdate`: Real-time notification on record update
- `onDelete`: Real-time notification on record deletion
- `observeQuery`: Real-time monitoring of query results

## How It Works

1. **Scan Phase**: Uses `ts-morph` to parse the TypeScript AST and track client instances generated by `generateClient()`
2. **Analysis Phase**: Detects operations called in the form `client.models.ModelName.operation()`
3. **Apply Phase**: Disables unused operation groups (queries/mutations/subscriptions) using `disableOperations()` based on detected usage

## Tech Stack

- **TypeScript**: Type-safe development
- **ts-morph**: TypeScript AST parsing and manipulation
- **Node.js**: Runtime environment

## Development

### Build
```bash
npm run build
```

### Run
```bash
npm start
```

## License

MIT
